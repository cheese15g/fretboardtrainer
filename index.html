<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Í∏∞ÌÉÄ Ïùå ÎßûÏ∂îÍ∏∞</title>
  <style>
    body {
      background: #111;
      color: #fff;
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 40px;
    }
    #targetNote {
      font-size: 80px;
      font-weight: bold;
      margin-bottom: 40px;
      color: #4cafef;
    }
    #detectedNote {
      font-size: 30px;
      color: #aaa;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div id="targetNote">-</div>
  <div id="detectedNote">üé∏ Í∞êÏßÄÎêú Ïùå: -</div>

  <script src="https://cdn.jsdelivr.net/npm/pitchy@4.0.2/dist/pitchy.umd.js"></script>
  <script>
    const notes = [
      "C", "C#", "D", "D#", "E", "F",
      "F#", "G", "G#", "A", "A#", "B"
    ];

    function getNoteName(frequency) {
      if (frequency <= 0) return null;
      const A4 = 440;
      const noteIndex = Math.round(12 * Math.log2(frequency / A4)) + 57;
      return notes[(noteIndex % 12 + 12) % 12]; // Ïò•ÌÉÄÎ∏åÎäî Î¨¥Ïãú
    }

    function getRandomNote() {
      return notes[Math.floor(Math.random() * notes.length)];
    }

    let targetNote = null;
    let lastDetectedNote = null;
    let noteStartTime = null;

    // ‚úÖ Ïï± ÏãúÏûë Ïãú ÏµúÏ¥à ÎûúÎç§ Ïùå ÏÑ§Ï†ï
    targetNote = getRandomNote();
    document.getElementById("targetNote").innerText = targetNote;

    async function init() {
      const audioContext = new AudioContext();
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      const source = audioContext.createMediaStreamSource(stream);
      const analyser = audioContext.createAnalyser();
      source.connect(analyser);

      const detector = Pitchy.createDetector(analyser, audioContext.sampleRate);
      const input = new Float32Array(detector.inputLength);

      async function detectPitch() {
        analyser.getFloatTimeDomainData(input);
        const [pitch, clarity] = detector.findPitch(input);

        if (clarity > 0.8) { // ÎÖ∏Ïù¥Ï¶à Ï†úÍ±∞, ÎØºÍ∞êÎèÑ
          const noteName = getNoteName(pitch);

          if (noteName) {
            // Ìï≠ÏÉÅ Í∞êÏßÄÎêú Ïùå ÌëúÏãú
            document.getElementById("detectedNote").innerText = "üé∏ Í∞êÏßÄÎêú Ïùå: " + noteName;

            // Ï†ïÎãµ Î°úÏßÅ
            if (noteName === targetNote) {
              if (lastDetectedNote !== noteName) {
                lastDetectedNote = noteName;
                noteStartTime = Date.now();
              } else {
                const elapsed = (Date.now() - noteStartTime) / 1000;
                // ‚úÖ 40Ï¥à Ïù¥ÏÉÅ Ïú†ÏßÄÌï¥Ïïº Ï†ïÎãµ Ïù∏Ï†ï
                if (elapsed >= 40) {
                  let newNote;
                  do {
                    newNote = getRandomNote();
                  } while (newNote === targetNote);
                  targetNote = newNote;
                  document.getElementById("targetNote").innerText = targetNote;
                  lastDetectedNote = null;
                  noteStartTime = null;
                }
              }
            } else {
              lastDetectedNote = noteName;
              noteStartTime = Date.now();
            }
          }
        }

        requestAnimationFrame(detectPitch);
      }

      detectPitch();
    }

    init();
  </script>
</body>
</html>
